CREATE OR REPLACE FUNCTION EMFESTADO (EMBARGO INT)
RETURNS INT
BEGIN
DECLARE ESTADO INT DEFAULT 0;
--
WITH EMFESTADO AS(
/*
EMBARGO
*/
SELECT MENUMSOL, METIPSOL, P2TIPDES
FROM EMF011PF
INNER JOIN EMF002PF ON P2TIPSOL = METIPSOL
WHERE MENUMSOL =EMBARGO AND MEESTADO = 5
UNION ALL
/*
  FIANZA O LEVANTAMIENTO
*/
SELECT MENUMSOL, METIPSOL, P2TIPDES
FROM EMF011PF
INNER JOIN EMF002PF ON P2TIPSOL = METIPSOL
WHERE MESOLANT =EMBARGO AND MEESTADO = 5

UNION ALL
/*CIERRE DE FIANZAS */
SELECT MENUMSOL, METIPSOL, P2TIPDES
FROM EMF011PF
INNER JOIN EMF002PF ON P2TIPSOL = METIPSOL
WHERE MESOLANT =
(
SELECT MENUMSOL
FROM EMF011PF
WHERE MESOLANT =EMBARGO AND MEESTADO = 5
) AND MEESTADO = 5
UNION ALL
/*LEVANTAMIENTO DEL EMBARGO CON FIANZA/CARTA*/
SELECT MENUMSOL, METIPSOL, P2TIPDES
FROM EMF011PF
INNER JOIN EMF002PF ON P2TIPSOL = METIPSOL
WHERE MESOLANT =
(
SELECT MENUMSOL
FROM EMF011PF
WHERE MESOLANT =
(
SELECT MENUMSOL
FROM EMF011PF
WHERE MESOLANT =EMBARGO AND MEESTADO = 5
) AND MEESTADO = 5
)AND MEESTADO = 5
)
SELECT MAX(METIPSOL) INTO ESTADO
FROM EMFESTADO ;
--
RETURN ESTADO;
END
